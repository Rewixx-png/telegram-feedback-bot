#!/bin/bash

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
REPO_URL="https://github.com/Rewixx-png/telegram-feedback-bot.git"
PROJECT_FOLDER="telegram-feedback-bot"

# --- –¶–í–ï–¢–ê –î–õ–Ø –í–´–í–û–î–ê ---
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# --- –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –í–´–í–û–î–ê –û–®–ò–ë–ö–ò –ò –í–´–•–û–î–ê ---
function error_exit {
    echo -e "${RED}–û–®–ò–ë–ö–ê: $1${NC}" >&2
    exit 1
}

clear
echo -e "${GREEN}--- –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫ Feedback Bot (–±–µ–∑ venv) ---${NC}"
echo "–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∑–∏—Ç, –Ω–∞—Å—Ç—Ä–æ–∏—Ç –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç –∫ –∑–∞–ø—É—Å–∫—É –≤–∞—à–µ–≥–æ –±–æ—Ç–∞."
echo ""

# --- 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π ---
echo "--> –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —É—Ç–∏–ª–∏—Ç..."
command -v git &> /dev/null || error_exit "Git –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–≥–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'sudo apt install git')."
command -v python3 &> /dev/null || error_exit "Python 3 –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–≥–æ."
command -v pip3 &> /dev/null || error_exit "pip3 –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–≥–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'sudo apt install python3-pip')."
command -v npm &> /dev/null || error_exit "NPM (Node.js) –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –û–Ω –Ω—É–∂–µ–Ω –¥–ª—è PM2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–≥–æ."
echo -e "${GREEN}–í—Å–µ –±–∞–∑–æ–≤—ã–µ —É—Ç–∏–ª–∏—Ç—ã –Ω–∞ –º–µ—Å—Ç–µ.${NC}"
echo ""

# --- 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PM2 (–µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ) ---
if ! command -v pm2 &> /dev/null; then
    echo -e "${YELLOW}–ú–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ PM2 –Ω–µ –Ω–∞–π–¥–µ–Ω.${NC}"
    read -p "–•–æ—Ç–∏—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –µ–≥–æ –≥–ª–æ–±–∞–ª—å–Ω–æ —á–µ—Ä–µ–∑ npm? [Y/n]: " confirm_pm2
    if [[ "$confirm_pm2" =~ ^[yY](es)?$ || -z "$confirm_pm2" ]]; then
        echo "--> –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é PM2..."
        sudo npm install pm2 -g || error_exit "–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å PM2."
        echo -e "${GREEN}PM2 —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.${NC}"
    else
        error_exit "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–µ—Ä–≤–∞–Ω–∞. PM2 –Ω–µ–æ–±—Ö–æ–¥–∏–º –¥–ª—è —Ä–∞–±–æ—Ç—ã."
    fi
else
    echo -e "${GREEN}PM2 —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.${NC}"
fi
echo ""

# --- 3. –í—ã–±–æ—Ä –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ ---
read -p "–£–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–æ—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: /root): " INSTALL_DIR
INSTALL_DIR=${INSTALL_DIR:-/root}

mkdir -p "$INSTALL_DIR" || error_exit "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é $INSTALL_DIR."
cd "$INSTALL_DIR" || error_exit "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–π—Ç–∏ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é $INSTALL_DIR."

echo "--> –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±—É–¥–µ—Ç –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∞ –≤: ${GREEN}$(pwd)${NC}"
echo ""

# --- 4. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è ---
if [ -d "$PROJECT_FOLDER" ]; then
    echo -e "${YELLOW}–ü–∞–ø–∫–∞ '$PROJECT_FOLDER' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.${NC}"
    read -p "–•–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –µ–µ –∏ —Å–∫–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ? (–í—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ –Ω–µ–π –±—É–¥—É—Ç —Å—Ç–µ—Ä—Ç—ã!) [y/N]: " confirm_delete
    if [[ "$confirm_delete" =~ ^[yY](es)?$ ]]; then
        rm -rf "$PROJECT_FOLDER"
    else
        error_exit "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–µ—Ä–≤–∞–Ω–∞."
    fi
fi

echo "--> –ö–ª–æ–Ω–∏—Ä—É—é —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π..."
git clone "$REPO_URL" || error_exit "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π."
cd "$PROJECT_FOLDER" || error_exit "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–π—Ç–∏ –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞."
APP_PATH=$(pwd)

# --- 5. –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ---
echo ""
echo -e "${GREEN}–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞:${NC}"

while [ -z "$BOT_TOKEN" ]; do
    read -p "–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –≤–∞—à–µ–≥–æ –±–æ—Ç–∞ –æ—Ç @BotFather: " BOT_TOKEN
done

while [ -z "$OWNER_ID" ]; do
    read -p "–í–≤–µ–¥–∏—Ç–µ –≤–∞—à —á–∏—Å–ª–æ–≤–æ–π Telegram ID (—É–∑–Ω–∞—Ç—å —É @userinfobot): " OWNER_ID
    [[ "$OWNER_ID" =~ ^[0-9]+$ ]] || { echo -e "${YELLOW}ID –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º!${NC}"; OWNER_ID=""; }
done

while [ -z "$LOG_CHAT_ID" ]; do
    read -p "–í–≤–µ–¥–∏—Ç–µ ID —á–∞—Ç–∞ –¥–ª—è –ª–æ–≥–æ–≤ (–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ, –Ω–∞–ø—Ä–∏–º–µ—Ä -100...): " LOG_CHAT_ID
    [[ "$LOG_CHAT_ID" =~ ^-100[0-9]+$ ]] || { echo -e "${YELLOW}ID —á–∞—Ç–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º, –Ω–∞—á–∏–Ω–∞—é—â–∏–º—Å—è —Å -100...${NC}"; LOG_CHAT_ID=""; }
done

echo ""
echo -e "${GREEN}–û—Ç–ª–∏—á–Ω–æ! –ù–∞—á–∏–Ω–∞—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É —Ñ–∞–π–ª–æ–≤...${NC}"

# --- 6. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ ---
echo "$BOT_TOKEN" > token.txt
sed -i "s/OWNER_ID\s*=\s*[0-9]*/OWNER_ID    = $OWNER_ID/" main.py
sed -i "s/LOG_CHAT_ID\s*=\s*-[0-9]*/LOG_CHAT_ID = $LOG_CHAT_ID/" main.py

echo "--> –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (pip3 install --user)..."
pip3 install --user -r requirements.txt || error_exit "–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏."

# --- 7. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ PM2 ---
BOT_NAME="feedback-bot-$(basename $APP_PATH)"
PYTHON_PATH=$(command -v python3) # –ù–∞—Ö–æ–¥–∏–º —Å–∏—Å—Ç–µ–º–Ω—ã–π python3
echo "--> –°–æ–∑–¥–∞—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è PM2 (ecosystem.config.js)..."

cat <<EOF > ecosystem.config.js
module.exports = {
  apps : [{
    name   : "$BOT_NAME",
    script : "main.py",
    interpreter: "$PYTHON_PATH",
    cwd: "$APP_PATH"
  }]
}
EOF

# --- 8. –§–∏–Ω–∞–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ ---
echo ""
echo -e "${GREEN}üéâ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! üéâ${NC}"
echo "–ë–æ—Ç –±—ã–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é: ${YELLOW}$APP_PATH${NC}"
echo "–ü—Ä–æ—Ü–µ—Å—Å –¥–ª—è PM2 –±—ã–ª –Ω–∞–∑–≤–∞–Ω: ${YELLOW}$BOT_NAME${NC}"
echo ""
echo -e "${YELLOW}--- –ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ—Ç–∞ ---${NC}"
echo "1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –ø–∞–ø–∫—É —Å –±–æ—Ç–æ–º:"
echo -e "   ${GREEN}cd $APP_PATH${NC}"
echo ""
echo "2. –ß—Ç–æ–±—ã –∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É:"
echo -e "   ${GREEN}pm2 start ecosystem.config.js${NC}"
echo ""
echo "3. –ß—Ç–æ–±—ã –±–æ—Ç –∑–∞–ø—É—Å–∫–∞–ª—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞:"
echo -e "   ${GREEN}pm2 save${NC}"
echo -e "   ${GREEN}pm2 startup${NC} (–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É, –∫–æ—Ç–æ—Ä—É—é –æ–Ω–∞ –≤–∞–º –ø–æ–∫–∞–∂–µ—Ç)"
echo ""
echo "4. –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã PM2:"
echo -e "   - –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏: ${GREEN}pm2 logs $BOT_NAME${NC}"
echo -e "   - –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞: ${GREEN}pm2 stop $BOT_NAME${NC}"
echo -e "   - –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞: ${GREEN}pm2 restart $BOT_NAME${NC}"
echo -e "   - –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤: ${GREEN}pm2 list${NC}"
echo ""
echo "–£–¥–∞—á–∏!"